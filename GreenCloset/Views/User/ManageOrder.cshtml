@{
    var ordersGrouped = (List<(Order Order, Dictionary<User, List<OrderDetail>> GroupedByStore)>)ViewBag.OrdersGrouped;
    ViewData["Title"] = "Lịch sử đơn hàng";
}

<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-lg rounded-3" style="min-height:500px">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <!-- Sidebar -->
                        <div class="col-lg-3 border-end">
                            <div class="p-4">
                                <div class="nav flex-column nav-pills">
                                    <a class="nav-link text-black" asp-action="Profile" asp-controller="User">
                                        <i class="fa fa-user me-2"></i> Thông tin cá nhân
                                    </a>
                                    <a class="nav-link text-black" asp-action="ChangePassword" asp-controller="User">
                                        <i class="fa fa-lock me-2"></i>Bảo mật
                                    </a>
                                    <a class="nav-link active text-white" asp-action="ManageOrder" asp-controller="Customer"
                                       style="background-color: #198754 !important;">
                                        <i class="fa fa-truck-fast me-2"></i> Lịch sử đơn hàng
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!-- Pills navs -->
                        <div class="col-lg-9">
                            <div class="p-4">
                                <ul class="nav nav-tabs nav-justified mb-3" id="ex1" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active w-100" id="tab-pending" data-bs-toggle="tab"
                                                data-bs-target="#content-pending" type="button" role="tab" aria-controls="content-pending"
                                                aria-selected="true">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="fa fa-spinner fa-2x text-warning"></i>
                                                <div class="ps-3">
                                                    <h4 class="mt-n1 mb-0">Đang chờ</h4>
                                                </div>
                                            </div>
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link w-100" id="tab-complete" data-bs-toggle="tab"
                                                data-bs-target="#content-complete" type="button" role="tab" aria-controls="content-complete"
                                                aria-selected="false">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="fa fa-check fa-2x text-primary"></i>
                                                <div class="ps-3">
                                                    <h4 class="mt-n1 mb-0">Hoàn thành</h4>
                                                </div>
                                            </div>
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link w-100" id="tab-cancel" data-bs-toggle="tab" data-bs-target="#content-cancel"
                                                type="button" role="tab" aria-controls="content-cancel" aria-selected="false">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="fa fa-xmark fa-2x text-danger"></i>
                                                <div class="ps-3">
                                                    <h4 class="mt-n1 mb-0">Hủy</h4>
                                                </div>
                                            </div>
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content">
                                    <!--Pending Menu-->

                                    <div class="tab-pane fade show active" id="content-pending" role="tabpanel"
                                         aria-labelledby="tab-pending">
                                        <div class="row g-4">
                                            @if (ordersGrouped != null && ordersGrouped.Any()){
                                                @foreach (var orderGroup in ordersGrouped)
                                                {
                                                    var order = orderGroup.Order;
                                                    var groupedByStore = orderGroup.GroupedByStore;

                                                    <div class="order-details border rounded p-3 bg-white shadow-sm" style="margin-top: 20px;">
                                                        <h2 class="mb-0 text-center">
                                                            Chi tiết đơn hàng #@order.Id
                                                        </h2>
                                                        <p class="text-center">Ngày đặt: @order.OrderDate.ToString("dd/MM/yyyy")</p>

                                                        @foreach (var storeGroup in groupedByStore)
                                                        {
                                                            var store = storeGroup.Key;
                                                            var orderDetails = storeGroup.Value;

                                                            <div class="store-section mb-0 p-1 border rounded bg-light" style="margin-top: 15px !important;">
                                                                <h4 class="text-primary mb-1">
                                                                    <i class="fa-solid fa-shop me-2"></i> @store?.UserName ?? "Cửa hàng không xác định"
                                                                </h4>

                                                                @if (orderDetails.Count > 0)
                                                                {
                                                                    var firstProduct = orderDetails[0];
                                                                    int rentalDays = 1;
                                                                    if (firstProduct.StartDate.HasValue && firstProduct.EndDate.HasValue)
                                                                    {
                                                                        rentalDays = (firstProduct.EndDate.Value - firstProduct.StartDate.Value).Days;
                                                                        if (rentalDays < 1) rentalDays = 1; 
                                                                    }
                                                                    var total = firstProduct.UnitPrice * firstProduct.Quantity * rentalDays;

                                                                    <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                                        <img src="@firstProduct.Product?.ProductAvatar?.ImagePath" style="width: 80px; height: 80px; object-fit: cover;" />
                                                                        <div>
                                                                            <div class="text-dark fw-bold mb-1">@firstProduct.Product?.Name</div>
                                                                            <div>Đơn giá: @firstProduct.UnitPrice.ToString("N0") ₫</div>
                                                                            <div>Màu: @firstProduct.Product?.Color?.ToString()</div>
                                                                            <div>Số lượng: @firstProduct.Quantity</div>
                                                                            <div>
                                                                                Size:
                                                                                @if (firstProduct.SizeShoe.HasValue)
                                                                                {
                                                                                    @firstProduct.SizeShoe.Value
                                                                                }
                                                                                else if (firstProduct.SizeClother.HasValue)
                                                                                {
                                                                                    @firstProduct.SizeClother.Value
                                                                                }
                                                                                else
                                                                                {
                                                                                    <text>Chưa chọn</text>
                                                                                }
                                                                            </div>

                                                                            @if (firstProduct.StartDate.HasValue && firstProduct.EndDate.HasValue)
                                                                            {
                                                                                <div>Số ngày thuê: @rentalDays ngày (@firstProduct.StartDate.Value.ToString("dd/MM/yyyy") - @firstProduct.EndDate.Value.ToString("dd/MM/yyyy"))</div>
                                                                            }
                                                                            <div>Thành tiền: <span class="text-danger">@total.ToString("N0") ₫</span></div>
                                                                        </div>
                                                                    </div>
                                                                }

                                                                @if (orderDetails.Count > 1)
                                                                {
                                                                    <div class="more-products d-none">
                                                                        @foreach (var detail in orderDetails.Skip(1))
                                                                        {
                                                                            int rentalDays = 1;
                                                                            if (detail.StartDate.HasValue && detail.EndDate.HasValue)
                                                                            {
                                                                                rentalDays = (detail.EndDate.Value - detail.StartDate.Value).Days;
                                                                                if (rentalDays < 1) rentalDays = 1;
                                                                            }
                                                                            var total = detail.UnitPrice * detail.Quantity * rentalDays;

                                                                            <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                                                <img src="@detail.Product?.ProductAvatar?.ImagePath" style="width: 80px; height: 80px; object-fit: cover;" />
                                                                                <div>
                                                                                    <div class="text-dark fw-bold mb-1">@detail.Product?.Name</div>
                                                                                    <div>Đơn giá: @detail.UnitPrice.ToString("N0") ₫</div>
                                                                                    <div>Màu: @detail.Product?.Color?.ToString()</div>
                                                                                    <div>Số lượng: @detail.Quantity</div>
                                                                                    @if (detail.StartDate.HasValue && detail.EndDate.HasValue)
                                                                                    {
                                                                                        <div>Số ngày thuê: @rentalDays ngày (@detail.StartDate.Value.ToString("dd/MM/yyyy") - @detail.EndDate.Value.ToString("dd/MM/yyyy"))</div>
                                                                                    }
                                                                                    <div>Thành tiền: <span class="text-danger">@total.ToString("N0") ₫</span></div>
                                                                                </div>
                                                                            </div>
                                                                        }
                                                                    </div>

                                                                    <div class="text-end">
                                                                        <button class="btn btn-sm btn-outline-primary show-more-btn" onclick="toggleProducts(this)">
                                                                            Xem thêm
                                                                        </button>
                                                                    </div>
                                                                }
                                                            </div>
                                                        }

                                                        <div class="text-end mt-2">
                                                            <h4 class="fw-bold text-dark">
                                                                Tổng tiền đơn hàng:
                                                                <span class="text-danger">@order.TotalPrice.ToString("N0") ₫</span>
                                                            </h4>
                                                        </div>

                                                        <div class="text-end">
                                                            <button class="btn btn-sm btn-outline-danger" asp-action="CancelOrder" asp-controller="Customer">
                                                                Hủy đơn
                                                            </button>
                                                        </div>
                                                    </div>
                                                }
                                            }else{
                                                <div class="empty-order-container text-center py-5">
                                                    <div class="empty-order-image mb-3">
                                                      <img
                                                        src="https://static.vecteezy.com/system/resources/previews/014/814/239/non_2x/no-order-a-flat-rounded-icon-is-up-for-premium-use-vector.jpg"
                                                        alt="Không có đơn hàng" width="120">
                                                    </div>
                                                    <h5 class="text-secondary">Chưa có đơn hàng đang chờ</h5>
                                                </div>
                                            }
                                            @* <!-- Order 1 -->
                                            <div class="order-details border rounded p-3 bg-white shadow-sm" style="margin-top: 20px;">
                                                <h2 class="mb-0 text-center" style="margin-top: 0px !important">Chi tiết đơn hàng #123456</h2>

                                                <!-- Cửa hàng A -->
                                                <div class="store-section mb-0 p-1 border rounded bg-light" style="margin-top: 10px !important;">
                                                    <h4 class="text-primary mb-1">
                                                        <i class="fa-solid fa-shop me-2"></i> Cửa hàng A
                                                    </h4>

                                                    <!-- Sản phẩm hiển thị mặc định -->
                                                    <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                        <img src="/image/products/product1.jpg"
                                                             style="width: 80px; height: 80px; object-fit: cover;" />
                                                        <div>
                                                            <div class="text-dark fw-bold mb-1">Giày Thể Thao Nam</div>
                                                            <div>Đơn giá: 1.200.000 ₫</div>
                                                            <div>Màu: Đen <span class="ms-2">Size: 42</span></div>
                                                            <div>Số lượng: 2</div>
                                                            <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                            <div>Thành tiền: <span class="text-danger">2.400.000 ₫</span></div>
                                                        </div>
                                                    </div>

                                                    <!-- Các sản phẩm ẩn -->
                                                    <div class="more-products d-none">
                                                        <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                            <img src="/image/products/product2.jpg"
                                                                 style="width: 80px; height: 80px; object-fit: cover;" />
                                                            <div>
                                                                <div class="text-dark fw-bold mb-1">Áo Khoác Gió</div>
                                                                <div>Đơn giá: 850.000 ₫</div>
                                                                <div>Màu: Xanh <span class="ms-2">Size: L</span></div>
                                                                <div>Số lượng: 1</div>
                                                                <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                                <div>Thành tiền: <span class="text-danger">850.000 ₫</span></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Nút xem thêm -->
                                                    <div class="text-end">
                                                        <button class="btn btn-sm btn-outline-primary show-more-btn"
                                                                style="margin-bottom: 3px !important; margin-top: 0px !important;"
                                                                onclick="toggleProducts(this)">
                                                            Xem thêm
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Cửa hàng B -->
                                                <div class="store-section mb-0 p-1 border rounded bg-light" style="margin-top: 15px !important;">
                                                    <h4 class="text-primary mb-1">
                                                        <i class="fa-solid fa-shop me-2"></i> Cửa hàng B
                                                    </h4>

                                                    <!-- Sản phẩm hiển thị mặc định -->
                                                    <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                        <img src="/image/products/product3.jpg"
                                                             style="width: 80px; height: 80px; object-fit: cover;" />
                                                        <div>
                                                            <div class="text-dark fw-bold mb-1">Túi Xách Nữ</div>
                                                            <div>Đơn giá: 1.500.000 ₫</div>
                                                            <div>Màu: Hồng <span class="ms-2">Size: -</span></div>
                                                            <div>Số lượng: 1</div>
                                                            <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                            <div>Thành tiền: <span class="text-danger">1.500.000 ₫</span></div>
                                                        </div>
                                                    </div>

                                                    <!-- Các sản phẩm ẩn -->
                                                    <div class="more-products d-none">
                                                        <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                            <img src="/image/products/product4.jpg"
                                                                 style="width: 80px; height: 80px; object-fit: cover;" />
                                                            <div>
                                                                <div class="text-dark fw-bold mb-1">Váy Dạ Hội</div>
                                                                <div>Đơn giá: 2.000.000 ₫</div>
                                                                <div>Màu: Đỏ <span class="ms-2">Size: M</span></div>
                                                                <div>Số lượng: 1</div>
                                                                <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                                <div>Thành tiền: <span class="text-danger">2.000.000 ₫</span></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Nút xem thêm -->
                                                    <div class="text-end">
                                                        <button class="btn btn-sm btn-outline-primary show-more-btn"
                                                                style="margin-bottom: 3px !important; margin-top: 0px !important;"
                                                                onclick="toggleProducts(this)">
                                                            Xem thêm
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Tổng tiền đơn hàng -->
                                                <div class="text-end mt-2">
                                                    <h4 class="fw-bold text-dark">
                                                        Tổng tiền đơn hàng:
                                                        <span class="text-danger">6.750.000 ₫</span>
                                                    </h4>
                                                </div>

                                                <!-- Hủy đơn -->
                                                <div class="text-end">
                                                    <button class="btn btn-sm btn-outline-danger"
                                                            style="margin-bottom: 0px !important; margin-top: 0px !important;">
                                                        Hủy đơn
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Order 2 -->
                                            <div class="order-details border rounded p-3 bg-white shadow-sm" style="margin-top: 20px;">
                                                <h2 class="mb-0 text-center" style="margin-top: 0px !important">Chi tiết đơn hàng #123456</h2>

                                                <!-- Cửa hàng A -->
                                                <div class="store-section mb-0 p-1 border rounded bg-light" style="margin-top: 10px !important;">
                                                    <h4 class="text-primary mb-1">
                                                        <i class="fa-solid fa-shop me-2"></i> Cửa hàng A
                                                    </h4>

                                                    <!-- Sản phẩm hiển thị mặc định -->
                                                    <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                        <img src="/image/products/product1.jpg"
                                                             style="width: 80px; height: 80px; object-fit: cover;" />
                                                        <div>
                                                            <div class="text-dark fw-bold mb-1">Giày Thể Thao Nam</div>
                                                            <div>Đơn giá: 1.200.000 ₫</div>
                                                            <div>Màu: Đen <span class="ms-2">Size: 42</span></div>
                                                            <div>Số lượng: 2</div>
                                                            <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                            <div>Thành tiền: <span class="text-danger">2.400.000 ₫</span></div>
                                                        </div>
                                                    </div>

                                                    <!-- Các sản phẩm ẩn -->
                                                    <div class="more-products d-none">
                                                        <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                            <img src="/image/products/product2.jpg"
                                                                 style="width: 80px; height: 80px; object-fit: cover;" />
                                                            <div>
                                                                <div class="text-dark fw-bold mb-1">Áo Khoác Gió</div>
                                                                <div>Đơn giá: 850.000 ₫</div>
                                                                <div>Màu: Xanh <span class="ms-2">Size: L</span></div>
                                                                <div>Số lượng: 1</div>
                                                                <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                                <div>Thành tiền: <span class="text-danger">850.000 ₫</span></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Nút xem thêm -->
                                                    <div class="text-end">
                                                        <button class="btn btn-sm btn-outline-primary show-more-btn"
                                                                style="margin-bottom: 3px !important; margin-top: 0px !important;"
                                                                onclick="toggleProducts(this)">
                                                            Xem thêm
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Cửa hàng B -->
                                                <div class="store-section mb-0 p-1 border rounded bg-light" style="margin-top: 15px !important;">
                                                    <h4 class="text-primary mb-1">
                                                        <i class="fa-solid fa-shop me-2"></i> Cửa hàng B
                                                    </h4>

                                                    <!-- Sản phẩm hiển thị mặc định -->
                                                    <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                        <img src="/image/products/product3.jpg"
                                                             style="width: 80px; height: 80px; object-fit: cover;" />
                                                        <div>
                                                            <div class="text-dark fw-bold mb-1">Túi Xách Nữ</div>
                                                            <div>Đơn giá: 1.500.000 ₫</div>
                                                            <div>Màu: Hồng <span class="ms-2">Size: -</span></div>
                                                            <div>Số lượng: 1</div>
                                                            <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                            <div>Thành tiền: <span class="text-danger">1.500.000 ₫</span></div>
                                                        </div>
                                                    </div>

                                                    <!-- Các sản phẩm ẩn -->
                                                    <div class="more-products d-none">
                                                        <div class="product-box d-flex align-items-center gap-3 mb-3 p-2 border rounded bg-white">
                                                            <img src="/image/products/product4.jpg"
                                                                 style="width: 80px; height: 80px; object-fit: cover;" />
                                                            <div>
                                                                <div class="text-dark fw-bold mb-1">Váy Dạ Hội</div>
                                                                <div>Đơn giá: 2.000.000 ₫</div>
                                                                <div>Màu: Đỏ <span class="ms-2">Size: M</span></div>
                                                                <div>Số lượng: 1</div>
                                                                <div>Số ngày thuê: 1 ngày (16/5/2025 - 17/5/2025)</div>
                                                                <div>Thành tiền: <span class="text-danger">2.000.000 ₫</span></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Nút xem thêm -->
                                                    <div class="text-end">
                                                        <button class="btn btn-sm btn-outline-primary show-more-btn"
                                                                style="margin-bottom: 3px !important; margin-top: 0px !important;"
                                                                onclick="toggleProducts(this)">
                                                            Xem thêm
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Tổng tiền đơn hàng -->
                                                <div class="text-end mt-2">
                                                    <h4 class="fw-bold text-dark">
                                                        Tổng tiền đơn hàng:
                                                        <span class="text-danger">6.750.000 ₫</span>
                                                    </h4>
                                                </div>

                                                <!-- Hủy đơn -->
                                                <div class="text-end">
                                                    <button class="btn btn-sm btn-outline-danger"
                                                            style="margin-bottom: 0px !important; margin-top: 0px !important;">
                                                        Hủy đơn
                                                    </button>
                                                </div>
                                            </div>
 *@
                                        </div>
                                    </div>
                                    <!--Complete Menu-->
                                    <div class="tab-pane fade " id="content-complete" role="tabpanel" aria-labelledby="tab-complete">
                                        <div class="row g-4">
                                            <div class="empty-order-container text-center py-5">
                                                <div class="empty-order-image mb-3">
                                                    <img src="https://static.vecteezy.com/system/resources/previews/014/814/239/non_2x/no-order-a-flat-rounded-icon-is-up-for-premium-use-vector.jpg"
                                                         alt="Không có đơn hàng" width="120">
                                                </div>
                                                <h5 class="text-secondary">Chưa có đơn hàng hoàn thành</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <!--Cancel Menu-->
                                    <div class="tab-pane fade  " id="content-cancel" role="tabpanel" aria-labelledby="tab-cancel">
                                        <div class="row g-4">
                                            <div class="empty-order-container text-center py-5">
                                                <div class="empty-order-image mb-3">
                                                    <img src="https://static.vecteezy.com/system/resources/previews/014/814/239/non_2x/no-order-a-flat-rounded-icon-is-up-for-premium-use-vector.jpg"
                                                         alt="Không có đơn hàng" width="120">
                                                </div>
                                                <h5 class="text-secondary">Chưa có đơn hàng hủy</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleProducts(button) {
            var moreProducts = button.closest('.store-section').querySelector('.more-products');
            if (moreProducts.classList.contains('d-none')) {
                moreProducts.classList.remove('d-none');
                button.innerText = 'Ẩn bớt';
            } else {
                moreProducts.classList.add('d-none');
                button.innerText = 'Xem thêm';
            }
        }
    </script>
}
<style>
    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }

        .nav-tabs .nav-link {
            border: none;
            background: transparent;
            padding: 10px 0;
            position: relative;
            color: #495057;
            text-align: left;
        }

            .nav-tabs .nav-link::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background-color: transparent;
                transition: all 0.3s ease;
            }

            .nav-tabs .nav-link.active {
                color: var(--primary-color);
                background-color: transparent;
            }

                .nav-tabs .nav-link.active::after {
                    background-color: var(--primary-color);
                }

            .nav-tabs .nav-link:hover:not(.active)::after {
                background-color: #dee2e6;
            }

</style>